<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector Control Form | EPHIS</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#2563eb" />
    <script type="module" src="main.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #0f172a;
            padding: 2rem;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 400px;
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 50%, #7c3aed 100%);
            z-index: -1;
            opacity: 0.05;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 2rem;
            color: #1e293b;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 1rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-section:last-child {
            border: none;
        }

        .form-section h3 {
            font-size: 1.1rem;
            color: #334155;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #475569;
            font-size: 0.9rem;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-outline {
            background: white;
            border: 2px solid #e2e8f0;
            color: #475569;
        }

        .btn-outline:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: #334155;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 50;
        }

        .toast.show {
            opacity: 1;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 id="pageTitle">New Vector Control Site</h1>

        <form id="siteForm">
            <div class="form-section">
                <h3>üìç Site Information</h3>
                <div class="form-grid">
                    <div>
                        <label>Site Name *</label>
                        <input type="text" id="site_name" required placeholder="e.g. Central Market Dumpsite">
                    </div>
                    <div>
                        <label>Site Type</label>
                        <select id="site_type">
                            <option value="">Select type</option>
                            <option>Residential Area</option>
                            <option>Water Body</option>
                            <option>Market</option>
                            <option>School</option>
                            <option>Hospital</option>
                            <option>Dumpsite</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div>
                        <label>Reporting Agency</label>
                        <input type="text" id="reporting_agency" placeholder="Dept. of Health">
                    </div>
                    <div>
                        <label>Responsible Officer</label>
                        <input type="text" id="responsible_officer">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>ü¶ü Vector & Risk</h3>
                <div class="form-grid">
                    <div>
                        <label>Vector Type *</label>
                        <select id="vector_type" required>
                            <option value="">Select vector type</option>
                            <option>Mosquito</option>
                            <option>Rodent</option>
                            <option>Fly</option>
                            <option>Tick</option>
                            <option>Flea</option>
                            <option>Bedbug</option>
                            <option>Cockroach</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label>Risk Level</label>
                        <select id="risk_level">
                            <option value="">Select risk level</option>
                            <option>Low</option>
                            <option>Medium</option>
                            <option>High</option>
                            <option>Critical</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div>
                        <label>Initial Intervention Type</label>
                        <select id="intervention_type">
                            <option value="">Select intervention</option>
                            <option>Fumigation/Spraying</option>
                            <option>Larviciding</option>
                            <option>Drainage Clearance</option>
                            <option>Public Awareness</option>
                            <option>Environmental Cleanup</option>
                            <option>Bednet Distribution</option>
                            <option>Rodent Control</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label>Intervention Date</label>
                        <input type="date" id="intervention_date">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>üåç Location</h3>
                <!-- RBAC Auto-filled -->
                <input type="hidden" id="county">
                <input type="hidden" id="sub_county">
                <input type="hidden" id="ward">

                <div class="form-grid">
                    <div>
                        <label>Specific Location Name *</label>
                        <input type="text" id="location_name" required placeholder="Village, Street, Landmark">
                    </div>
                    <div>
                        <label>Description</label>
                        <input type="text" id="location" placeholder="Additional details">
                    </div>
                </div>
                <div class="form-grid">
                    <div>
                        <label>Latitude</label>
                        <input type="number" step="any" id="latitude">
                    </div>
                    <div>
                        <label>Longitude</label>
                        <input type="number" step="any" id="longitude">
                    </div>
                </div>
                <button type="button" class="btn btn-outline" id="getLocationBtn" style="width:100%">üì° Get Current
                    GPS</button>
                <p id="locationStatus" style="font-size:0.85rem; color:#64748b; margin-top:0.5rem; text-align:center;">
                </p>
            </div>

            <div class="form-section">
                <h3>üìù Remarks</h3>
                <textarea id="remarks" rows="3" placeholder="Any additional notes..."></textarea>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-outline" onclick="history.back()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="saveBtn">Save Record</button>
            </div>
        </form>
    </div>

    <div id="toast" class="toast"></div>

    <script type="module">
        import { supabase } from "./main.js";
        import { getCurrentUserProfile } from "./locationAccessControl.js";

        const form = document.getElementById('siteForm');
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const pageTitle = document.getElementById('pageTitle');
        const saveBtn = document.getElementById('saveBtn');
        const toast = document.getElementById('toast');

        function showToast(msg, type = 'info') {
            toast.textContent = msg;
            toast.style.background = type === 'error' ? '#dc2626' : '#2563eb';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        async function init() {
            // Check Session & RBAC
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) window.location.href = 'login.html';

            const profile = await getCurrentUserProfile(supabase);
            if (profile) {
                // Auto-fill location for new records
                if (!id) {
                    if (profile.county) document.getElementById('county').value = profile.county;
                    if (profile.sub_county) document.getElementById('sub_county').value = profile.sub_county;
                    if (profile.ward) document.getElementById('ward').value = profile.ward;
                }
            }

            if (id) {
                pageTitle.textContent = 'Edit Vector Control Site';
                await loadSite(id);
            }
        }

        async function loadSite(siteId) {
            const { data, error } = await supabase.from('vector_sites').select('*').eq('id', siteId).single();
            if (error) {
                console.error(error);
                showToast('Error loading site data', 'error');
                return;
            }

            // Fill form
            for (const key in data) {
                const input = document.getElementById(key);
                if (input) {
                    if (input.type === 'date' && data[key]) {
                        input.value = data[key].split('T')[0];
                    } else {
                        input.value = data[key] || '';
                    }
                }
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            const formData = {
                site_name: document.getElementById('site_name').value,
                site_type: document.getElementById('site_type').value,
                reporting_agency: document.getElementById('reporting_agency').value,
                responsible_officer: document.getElementById('responsible_officer').value,
                vector_type: document.getElementById('vector_type').value,
                risk_level: document.getElementById('risk_level').value,
                intervention_type: document.getElementById('intervention_type').value,
                intervention_date: document.getElementById('intervention_date').value || null,
                county: document.getElementById('county').value,
                sub_county: document.getElementById('sub_county').value,
                ward: document.getElementById('ward').value,
                location_name: document.getElementById('location_name').value,
                location: document.getElementById('location').value,
                latitude: document.getElementById('latitude').value || null,
                longitude: document.getElementById('longitude').value || null,
                remarks: document.getElementById('remarks').value,
            };

            let error;
            if (id) {
                const { error: updateError } = await supabase.from('vector_sites').update(formData).eq('id', id);
                error = updateError;
            } else {
                const { error: insertError } = await supabase.from('vector_sites').insert([formData]);
                error = insertError;
            }

            if (error) {
                console.error(error);
                showToast('Failed to save record', 'error');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Record';
            } else {
                showToast('Record saved successfully');
                setTimeout(() => window.location.href = 'vector_control.html', 1000);
            }
        });

        // GPS Logic
        document.getElementById('getLocationBtn').addEventListener('click', () => {
            const status = document.getElementById('locationStatus');
            if (!navigator.geolocation) {
                status.textContent = 'Geolocation not supported';
                return;
            }
            status.textContent = 'Acquiring signal...';
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('latitude').value = pos.coords.latitude.toFixed(6);
                document.getElementById('longitude').value = pos.coords.longitude.toFixed(6);
                status.textContent = '‚úÖ Location Updated';
                status.style.color = 'green';
            }, err => {
                status.textContent = '‚ùå Error: ' + err.message;
                status.style.color = 'red';
            });
        });

        init();
    </script>
</body>

</html>