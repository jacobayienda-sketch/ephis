<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EPHIS | Dashboard</title>
<link rel="manifest" href="manifest.json" />
<script type="module" src="main.js"></script>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Inter',sans-serif;
background:#f8fafc;margin:0;color:#1e293b;}
header{background:white;box-shadow:0 1px 3px rgba(0,0,0,0.06);}
.header-container{max-width:1400px;margin:0 auto;padding:1rem 1.5rem;
display:flex;justify-content:space-between;align-items:center;}
h1{font-size:1.2rem;background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.user-info{display:flex;align-items:center;gap:0.5rem;}
.user-avatar{background:#2563eb;color:white;font-weight:700;border-radius:50%;
width:36px;height:36px;display:flex;align-items:center;justify-content:center;}
.search-bar{max-width:300px;width:100%;}
.search-bar input{width:100%;padding:0.5rem 0.75rem;border:1px solid #cbd5e1;
border-radius:8px;font-size:0.9rem;}
.btn-logout{background:#ef4444;color:white;border:none;border-radius:8px;padding:0.5rem 0.9rem;cursor:pointer;font-weight:600;}
main{max-width:1400px;margin:0 auto;padding:1.5rem;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;}
.card{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08);padding:1rem;position:relative;cursor:pointer;}
.card h3{margin:0 0 0.3rem;color:#2563eb;font-size:1.05rem;}
.card p{margin:0.2rem 0;font-size:0.9rem;}
footer{text-align:center;background:white;color:#64748b;font-size:0.85rem;padding:1rem;border-top:1px solid #e5e7eb;}
.quickbar{display:flex;gap:0.75rem;overflow-x:auto;background:white;border-bottom:1px solid #e5e7eb;padding:0.6rem 1rem;position:sticky;top:60px;z-index:50;}
.quickbar::-webkit-scrollbar{display:none;}
.quickbar-item{background:#2563eb;color:white;border:none;border-radius:10px;padding:0.5rem 0.8rem;font-weight:600;white-space:nowrap;cursor:pointer;transition:background 0.2s;}
.quickbar-item:hover{background:#1d4ed8;}
.quickbar-empty{color:#94a3b8;font-size:0.9rem;padding:0.3rem 0.5rem;}
</style>
</head>

<body>
<header>
  <div class="header-container">
    <h1>Environmental Public Health Information System (EPHIS)</h1>
    <div class="user-info">
      <div class="user-avatar">U</div>
      <span class="user-name">John Doe</span>
      <div class="search-bar"><input id="searchInput" type="text" placeholder="Search modules ( / )" /></div>
      <button id="logout" class="btn-logout">Logout</button>
    </div>
  </div>
</header>

<!-- Quick access bar -->
<div id="quickBar" class="quickbar"></div>

<main>
  <!-- Example Module Cards -->
  <div class="grid">
    <div class="card" data-module="Premises" data-url="premises.html" data-keywords="premises inspection compliance registration">
      <h3>Premises Management</h3>
      <p>Register and inspect business premises.</p>
    </div>
    <div class="card" data-module="Complaints" data-url="complaints.html" data-keywords="complaints incidents reports">
      <h3>Complaints & Incidents</h3>
      <p>Report and track public complaints.</p>
    </div>
    <div class="card" data-module="Inspections" data-url="inspections.html" data-keywords="inspection schedule followup">
      <h3>Inspection Management</h3>
      <p>Plan, conduct, and monitor inspections.</p>
    </div>
    <div class="card" data-module="Licensing" data-url="premises_licenses.html" data-keywords="licenses renewal compliance">
      <h3>Licensing</h3>
      <p>Issue and renew business licenses.</p>
    </div>
    <div class="card" data-module="Water Quality" data-url="water_quality.html" data-keywords="water sampling lab results">
      <h3>Water Quality Monitoring</h3>
      <p>Collect and analyze water samples.</p>
    </div>
    <div class="card" data-module="Waste Management" data-url="waste_management.html" data-keywords="waste collection disposal">
      <h3>Waste Management</h3>
      <p>Monitor collection, disposal and recycling sites.</p>
    </div>
    <div class="card" data-module="Vector Control" data-url="vector_control.html" data-keywords="vector mosquito rodent control">
      <h3>Vector Control</h3>
      <p>Manage surveillance and interventions.</p>
    </div>
    <div class="card" data-module="Food Control" data-url="food_control.html" data-keywords="food safety hygiene licensing">
      <h3>Food Control</h3>
      <p>Inspect food premises and enforce hygiene standards.</p>
    </div>
    <div class="card" data-module="Officer" data-url="officer_dashboard.html" data-keywords="tasks followups alerts performance">
      <h3>Officer Operations</h3>
      <p>Manage field tasks, alerts, and performance.</p>
    </div>
  </div>
</main>

<footer>
  County Government of Elgeyo Marakwet • EPHIS © <span id="year"></span>
</footer>

<!-- ==================== JAVASCRIPT ==================== -->
<script type="module">
import { supabase } from "./main.js";

document.getElementById("year").textContent = new Date().getFullYear();
let currentUser = null;

// ---- Session & User Info ----
async function checkSession() {
  const { data } = await supabase.auth.getSession();
  if (!data.session) return (window.location.href = "login.html");
  currentUser = data.session.user;
  const name =
    currentUser.user_metadata?.full_name ||
    currentUser.email.split("@")[0] ||
    "User";
  const initials = name
    .split(" ")
    .map((n) => n[0])
    .join("")
    .substring(0, 2)
    .toUpperCase();
  document.querySelector(".user-avatar").textContent = initials;
  const nameEl = document.querySelector(".user-name");
  nameEl.textContent = name;
  nameEl.style.cursor = "pointer";
  nameEl.title = "Go to Officer Dashboard";
  nameEl.onclick = () => (window.location.href = "officer_dashboard.html");
  renderFavorites();
  renderRecentModules();
  renderQuickBar();
}
checkSession();

// ---- FAVORITES ----
function getFavKey() { return `favorites_${currentUser?.id}`; }
function getFavs() { return JSON.parse(localStorage.getItem(getFavKey())) || []; }
function saveFavs(f) { localStorage.setItem(getFavKey(), JSON.stringify(f)); }

function toggleFav(name, url) {
  const favs = getFavs();
  const exists = favs.find((f) => f.name === name);
  const updated = exists ? favs.filter((f) => f.name !== name) : [...favs, { name, url }];
  saveFavs(updated); renderFavorites(); renderQuickBar(); highlightFavs();
}

function renderFavorites() {
  if (!currentUser) return;
  const favs = getFavs();
  const old = document.querySelector(".favorites"); if (old) old.remove();
  const sec = document.createElement("section");
  sec.classList.add("favorites");
  sec.style.margin = "1rem 0";
  sec.innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="color:#2563eb;">Favorites</h2>
    ${favs.length ? '<button id="clearFav" style="background:#ef4444;color:white;border:none;border-radius:8px;padding:0.4rem 0.8rem;cursor:pointer;font-weight:600;">Clear</button>' : ''}
  </div>
  <div class="fav-grid" style="display:flex;flex-wrap:wrap;gap:0.75rem;margin-top:0.75rem;">
    ${favs.length ? favs.map(f=>`<button style="background:white;border:1px solid #e2e8f0;border-radius:10px;padding:0.6rem 1rem;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,0.05);" onclick="window.location.href='${f.url}'">${f.name}</button>`).join('') : '<p>No favorites yet.</p>'}
  </div>`;
  document.querySelector("main").insertBefore(sec, document.querySelector("main").firstChild);
  if (favs.length) document.getElementById("clearFav").addEventListener("click", () => { localStorage.removeItem(getFavKey()); renderFavorites(); highlightFavs(); renderQuickBar(); });
}

function highlightFavs() {
  const favs = getFavs(); const cards = document.querySelectorAll(".card");
  cards.forEach(c => {
    let star = c.querySelector(".fav-star");
    const name = c.querySelector("h3,h2,p")?.textContent.trim();
    const url = c.dataset.url || "#";
    const isFav = favs.some(f => f.name === name);
    if (!star) {
      star = document.createElement("span");
      star.classList.add("fav-star");
      star.textContent = "⭐";
      star.title = "Toggle Favorite";
      star.style.cssText="position:absolute;top:8px;right:12px;font-size:1.2rem;cursor:pointer;opacity:0.3;";
      c.appendChild(star);
    }
    star.style.opacity = isFav ? "1" : "0.3";
    star.onclick = e => { e.stopPropagation(); toggleFav(name, url); };
  });
}
setTimeout(highlightFavs, 800);

// ---- RECENTLY ACCESSED ----
function trackRecent(name,url){
  const key=`recentModules_${currentUser.id}`;
  const list=JSON.parse(localStorage.getItem(key))||[];
  const filtered=list.filter(m=>m.name!==name);
  filtered.unshift({name,url});
  localStorage.setItem(key,JSON.stringify(filtered.slice(0,4)));
}
function renderRecentModules(){
  if(!currentUser)return;
  const key=`recentModules_${currentUser.id}`;
  const list=JSON.parse(localStorage.getItem(key))||[];
  const old=document.querySelector(".recent-modules");if(old)old.remove();
  const sec=document.createElement("section");
  sec.classList.add("recent-modules");
  sec.style.margin="1rem 0";
  sec.innerHTML=`
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="color:#2563eb;">Recently Accessed</h2>
    <button id="clearRecent" style="background:#ef4444;color:white;border:none;border-radius:8px;padding:0.4rem 0.8rem;cursor:pointer;font-weight:600;">Clear History</button>
  </div>
  <div class="recent-grid" style="display:flex;flex-wrap:wrap;gap:0.75rem;margin-top:0.75rem;">
    ${list.length?list.map(m=>`<button style="background:white;border:1px solid #e2e8f0;border-radius:10px;padding:0.6rem 1rem;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,0.05);" onclick="window.location.href='${m.url}'">${m.name}</button>`).join(''):'<p>No recent modules yet.</p>'}
  </div>`;
  document.querySelector("main").insertBefore(sec, document.querySelector(".favorites")?.nextSibling||document.querySelector("main").firstChild);
  document.getElementById("clearRecent").addEventListener("click",()=>{localStorage.removeItem(key);renderRecentModules();});
}

// ---- QUICKBAR ----
function renderQuickBar(){
  if(!currentUser)return;
  const favs=JSON.parse(localStorage.getItem(`favorites_${currentUser.id}`))||[];
  const bar=document.getElementById("quickBar");
  if(!favs.length){bar.innerHTML='<span class="quickbar-empty">⭐ Pin modules to access them here</span>';return;}
  bar.innerHTML=favs.map(f=>`<button class="quickbar-item" title="${f.name}" onclick="window.location.href='${f.url}'">${f.name}</button>`).join('');
}

// ---- Search ----
const searchInput=document.getElementById("searchInput");
searchInput.addEventListener("keyup",e=>{
  const q=e.target.value.toLowerCase();
  const cards=document.querySelectorAll(".card");
  let visible=0;
  cards.forEach(c=>{
    const txt=c.textContent.toLowerCase()+(c.dataset.keywords||"");
    const match=txt.includes(q);
    c.style.display=match?"block":"none";if(match)visible++;
  });
  let msg=document.querySelector(".no-results");
  if(!msg){
    msg=document.createElement("div");
    msg.classList.add("no-results");
    msg.innerHTML=`<p style="color:#94a3b8;">No matching modules found.</p>`;
    document.querySelector("main").appendChild(msg);
  }
  msg.style.display=visible?"none":"block";
});
document.addEventListener("keydown",e=>{if(e.key==="/"){e.preventDefault();searchInput.focus();}});

// ---- Click tracking ----
document.addEventListener("click",e=>{
  const c=e.target.closest(".card");
  if(c&&c.dataset.module){
    const name=c.querySelector("h3,h2,p")?.textContent.trim()||"Module";
    const url=c.dataset.url||"#";
    trackRecent(name,url);
  }
});

// ---- Logout ----
document.getElementById("logout").addEventListener("click",async()=>{
  if(currentUser){
    localStorage.removeItem(`recentModules_${currentUser.id}`);
    localStorage.removeItem(`favorites_${currentUser.id}`);
  }
  await supabase.auth.signOut();
  window.location.href="login.html";
});
</script>
</body>
</html>
