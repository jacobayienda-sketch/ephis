<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EPHIS Portal | Premises Management</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Minimal pager styles */
    .pager { display:flex; gap:.5rem; align-items:center; margin-top:.5rem; }
    .pager button { padding:.25rem .5rem; }
    .pager .info { margin-left:.5rem; color:#666; }
    mark { background: #ffef8b; padding:0 .125rem; border-radius:2px; }
    .controls { display:flex; gap:1rem; align-items:center; }
    .table-responsive { overflow:auto; }
    td.rank { text-align: right; font-variant-numeric: tabular-nums; color:#333; }
  </style>
</head>
<body>
  <header><h1>EPHIS Portal</h1></header>
  <nav class="top-nav">
    <a href="dashboard.html">Dashboard</a>
    <button id="logoutBtn">Logout</button>
  </nav>

  <main>
    <section class="card">
      <h2>Registered Premises</h2>

      <div class="grid four">
        <div>
          <label>Sub-County</label>
          <select id="filterSub">
            <option value="">All</option>
            <option>Keiyo North</option><option>Keiyo South</option>
            <option>Marakwet East</option><option>Marakwet West</option>
          </select>
        </div>

        <div>
          <label>Status</label>
          <select id="filterStatus">
            <option value="">All</option>
            <option>Active</option><option>Expired</option><option>Pending</option>
          </select>
        </div>

        <div>
          <label>License Expiry Before</label>
          <input type="date" id="filterExpiry" />
        </div>

        <div>
          <label>Search</label>
          <input type="search" id="filterSearch" placeholder="Search premises..." />
        </div>
      </div>

      <div class="controls" style="margin-top:.75rem;">
        <div>
          <label>Page size</label>
          <select id="pageSizeSelect">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>

        <div style="margin-left:auto">
          <button class="btn-primary" id="btnAdd">Add Premise</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Name</th><th>Type</th><th>Owner</th><th>Sub-County</th>
              <th>Ward</th><th>Status</th><th>License Expiry</th><th>Remarks</th><th>Relevance</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="9" align="center">Loading records…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pager" id="pager" aria-live="polite">
        <button id="prevBtn" disabled>&laquo; Prev</button>
        <button id="nextBtn" disabled>Next &raquo;</button>
        <div class="info" id="pageInfo">Page 1</div>
      </div>
    </section>

    <section id="formSection" class="card hidden">
      <h3>Register New Premise</h3>
      <form id="premiseForm" class="grid two" autocomplete="off">
        <label>Premise Name</label><input type="text" id="premise_name" required />
        <label>Premise Type</label><input type="text" id="premise_type" required />
        <label>Owner Name</label><input type="text" id="owner_name" required />
        <label>Contact</label><input type="tel" id="contact_phone" />
        <label>Sub-County</label>
        <select id="sub_county" required>
          <option>Keiyo North</option><option>Keiyo South</option>
          <option>Marakwet East</option><option>Marakwet West</option>
        </select>
        <label>Ward</label><input type="text" id="ward" />
        <label>Status</label>
        <select id="status" required><option>Active</option><option>Pending</option><option>Expired</option></select>
        <label>License Expiry</label><input type="date" id="license_expiry" />
        <label>Remarks</label><textarea id="remarks" rows="2"></textarea>
        <button type="submit" class="btn-primary">Save</button>
        <button type="button" id="cancelBtn" class="btn-secondary">Cancel</button>
      </form>
    </section>
  </main>

  <script type="module">
    import { supabase } from "./supabaseClient.js";

    // UI refs
    const logoutBtn = document.getElementById("logoutBtn");
    const btnAdd = document.getElementById("btnAdd");
    const cancelBtn = document.getElementById("cancelBtn");
    const formSec = document.getElementById("formSection");
    const form = document.getElementById("premiseForm");
    const tableBody = document.getElementById("tableBody");

    const filterSub = document.getElementById("filterSub");
    const filterStatus = document.getElementById("filterStatus");
    const filterExpiry = document.getElementById("filterExpiry");
    const filterSearch = document.getElementById("filterSearch");
    const pageSizeSelect = document.getElementById("pageSizeSelect");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageInfo = document.getElementById("pageInfo");

    // form fields
    const premise_name = document.getElementById("premise_name");
    const premise_type = document.getElementById("premise_type");
    const owner_name = document.getElementById("owner_name");
    const contact_phone = document.getElementById("contact_phone");
    const sub_county = document.getElementById("sub_county");
    const ward = document.getElementById("ward");
    const status = document.getElementById("status");
    const license_expiry = document.getElementById("license_expiry");
    const remarks = document.getElementById("remarks");

    // pagination state
    let currentPage = 1;
    let pageSize = Number(pageSizeSelect.value);
    let totalCount = 0;

    // debounce timer
    let searchDebounceTimer = null;

    // placeholder map marker helpers
    let markers = [];
    function clearMarkers(){ markers.forEach(m => { try { if (m.remove) m.remove(); } catch(e){} }); markers = []; }
    function addMarker(lat, lng, popupHtml){ if (lat==null||lng==null) return; markers.push({lat,lng,popupHtml,remove:()=>{}}); }

    // escaping & highlighting helpers
    function escapeHtml(str){ if (str == null) return ""; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
    function escapeRegex(str){ return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function highlightEscapedHtml(escapedHtml, query){
      if (!query) return escapedHtml;
      const tokens = query.split(/\s+/).filter(Boolean);
      let result = escapedHtml;
      tokens.forEach(t => { const re = new RegExp('(' + escapeRegex(t) + ')', "ig"); result = result.replace(re, "<mark>$1</mark>"); });
      return result;
    }

    // Auth guard
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session) window.location = "login.html";
    logoutBtn.onclick = async()=> { await supabase.auth.signOut(); window.location="login.html"; };

    // Core: call server RPC search_premises_ranked which returns items + total (and rank)
    async function loadPremises(page = 1) {
      currentPage = page;
      pageSize = Number(pageSizeSelect.value) || 25;
      const offset = (currentPage - 1) * pageSize;

      tableBody.innerHTML = "<tr><td colspan='9' align='center'>Loading…</td></tr>";

      const q = filterSearch.value?.trim() || null;
      const sub = filterSub.value?.trim() || null;
      const st = filterStatus.value?.trim() || null;
      const expiryRaw = filterExpiry.value?.trim() || null;
      const expiry = expiryRaw ? (expiryRaw.length === 10 ? expiryRaw + "T23:59:59Z" : expiryRaw) : null;

      // Call the ranked RPC. RLS will be applied on the DB (SECURITY INVOKER recommended).
      const { data, error } = await supabase
        .rpc('search_premises_ranked', { _q: q, _sub_county: sub, _status: st, _expiry: expiry, _limit: pageSize, _offset: offset });

      if (error) {
        tableBody.innerHTML = `<tr><td colspan='9'>${escapeHtml(error.message)}</td></tr>`;
        clearMarkers();
        return;
      }
      if (!data) {
        tableBody.innerHTML = "<tr><td colspan='9' align='center'>No records found</td></tr>";
        clearMarkers();
        totalCount = 0;
        updatePager();
        return;
      }

      const items = data.items || [];
      totalCount = data.total || 0;

      if (!items.length) {
        tableBody.innerHTML = "<tr><td colspan='9' align='center'>No records found</td></tr>";
        clearMarkers();
        updatePager();
        return;
      }

      clearMarkers();

      const searchForHighlight = q || "";
      tableBody.innerHTML = items.map(p => {
        const name = escapeHtml(p.premise_name || "");
        const type = escapeHtml(p.premise_type || "");
        const owner = escapeHtml(p.owner_name || "");
        const subc = escapeHtml(p.sub_county || "");
        const wrd = escapeHtml(p.ward || "");
        const stt = escapeHtml(p.status || "");
        const expiryDisplay = escapeHtml((p.license_expiry && String(p.license_expiry).split("T")[0]) || "");
        const rem = escapeHtml(p.remarks || "");
        const rankVal = (typeof p.rank !== 'undefined' && p.rank !== null) ? Number(p.rank) : null;

        const hName = highlightEscapedHtml(name, searchForHighlight);
        const hType = highlightEscapedHtml(type, searchForHighlight);
        const hOwner = highlightEscapedHtml(owner, searchForHighlight);
        const hSub = highlightEscapedHtml(subc, searchForHighlight);
        const hWard = highlightEscapedHtml(wrd, searchForHighlight);
        const hRem = highlightEscapedHtml(rem, searchForHighlight);

        if (p.latitude != null && p.longitude != null) addMarker(Number(p.latitude), Number(p.longitude), `<strong>${name}</strong><br/>${type}<br/>${owner}`);

        return `
          <tr>
            <td>${hName}</td>
            <td>${hType}</td>
            <td>${hOwner}</td>
            <td>${hSub}</td>
            <td>${hWard}</td>
            <td>${stt}</td>
            <td>${expiryDisplay}</td>
            <td>${hRem}</td>
            <td class="rank">${rankVal !== null ? rankVal.toFixed(3) : ''}</td>
          </tr>
        `;
      }).join("");

      updatePager();
    }

    function updatePager(){
      const totalPages = Math.max(1, Math.ceil((totalCount || 0) / pageSize));
      pageInfo.textContent = `Page ${currentPage} of ${totalPages} — ${totalCount} result${totalCount === 1 ? "" : "s"}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }

    // UI wiring
    btnAdd.onclick = () => formSec.classList.toggle("hidden");
    cancelBtn.onclick = () => formSec.classList.add("hidden");

    filterSub.addEventListener("change", () => loadPremises(1));
    filterStatus.addEventListener("change", () => loadPremises(1));
    filterExpiry.addEventListener("change", () => loadPremises(1));
    pageSizeSelect.addEventListener("change", () => loadPremises(1));

    filterSearch.addEventListener("input", () => {
      clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(() => loadPremises(1), 250);
    });

    prevBtn.addEventListener("click", () => { if (currentPage > 1) loadPremises(currentPage - 1); });
    nextBtn.addEventListener("click", () => { loadPremises(currentPage + 1); });

    form.onsubmit = async e => {
      e.preventDefault();
      const record = {
        premise_name: premise_name.value,
        premise_type: premise_type.value,
        owner_name: owner_name.value,
        contact_phone: contact_phone.value,
        sub_county: sub_county.value,
        ward: ward.value,
        status: status.value,
        license_expiry: license_expiry.value || null,
        remarks: remarks.value,
        created_by: session.user.id
      };
      const { error } = await supabase.from("premises").insert([record]);
      if (error) alert("Save failed: " + error.message);
      else {
        alert("Premise registered");
        form.reset();
        formSec.classList.add("hidden");
        loadPremises(1);
      }
    };

    // initial load
    await loadPremises(1);
  </script>
</body>
</html>
