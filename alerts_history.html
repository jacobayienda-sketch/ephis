<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EPHIS | Alerts History</title>
<link rel="manifest" href="manifest.json" />
<script type="module" src="main.js"></script>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
  background: linear-gradient(135deg, #f8fafc 0%, #fef3c7 100%);
  margin: 0;
  color: #1e293b;
}
header {
  background: white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
}
.header-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
h1 {
  font-size: 1.2rem;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
main {
  max-width: 1400px;
  margin: 0 auto;
  padding: 1.5rem;
}
.filter-bar {
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  padding: 1rem 1.5rem;
  margin-bottom: 1.5rem;
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: center;
}
.filter-bar select,
.filter-bar input {
  padding: 0.6rem;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
}
.btn-primary {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.6rem 1rem;
  font-weight: 600;
  cursor: pointer;
}
.btn-secondary {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.6rem 1rem;
  font-weight: 600;
  cursor: pointer;
}
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 1rem;
}
.card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  padding: 1rem;
}
.card h3 {
  margin: 0;
  color: #2563eb;
  font-size: 1.05rem;
}
.card p {
  margin: 0.25rem 0;
  font-size: 0.9rem;
}
footer {
  text-align: center;
  background: white;
  color: #64748b;
  font-size: 0.85rem;
  padding: 1rem;
}
.toast {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  opacity: 0;
  transition: opacity 0.3s;
}
.toast.show {
  opacity: 1;
}
</style>
</head>

<body>
<header>
  <div class="header-container">
    <h1>Alerts History</h1>
    <button class="btn-secondary" onclick="window.location.href='my_alerts.html'">Back</button>
  </div>
</header>

<main>
  <div class="filter-bar">
    <label>Alert Type</label>
    <select id="filterType">
      <option value="">All Types</option>
      <option value="Contamination">Contamination</option>
      <option value="Waste Dumping">Waste Dumping</option>
      <option value="Water Pollution">Water Pollution</option>
      <option value="Vector Breeding">Vector Breeding</option>
    </select>

    <label>From</label>
    <input type="date" id="filterStart" />
    <label>To</label>
    <input type="date" id="filterEnd" />

    <button id="applyFilter" class="btn-primary">Apply Filter</button>
  </div>

  <div class="grid" id="alertGrid"></div>
</main>

<footer>
  County Government of Elgeyo Marakwet • EPHIS © <span id="year"></span>
</footer>

<div id="toast" class="toast"></div>

<script type="module">
import { supabase } from "./main.js";
const toast=document.getElementById("toast");
function showToast(m){toast.textContent=m;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),3000);}
document.getElementById("year").textContent=new Date().getFullYear();
let officerId=null;

async function checkSession(){
  const {data}=await supabase.auth.getSession();
  if(!data.session)window.location.href="login.html";
  else{officerId=data.session.user.id;loadAlerts();}
}
checkSession();

async function loadAlerts(filters={}){
  let query=supabase.from("building_alerts")
    .select("*")
    .in("status",["Resolved","Referred"])
    .order("updated_at",{ascending:false});
  if(filters.type)query=query.eq("alert_type",filters.type);
  if(filters.start)query=query.gte("alert_date",filters.start);
  if(filters.end)query=query.lte("alert_date",filters.end);
  const {data,error}=await query;
  if(error){console.error(error);showToast("Error loading alerts");return;}
  renderAlerts(data);
}

function renderAlerts(list){
  const grid=document.getElementById("alertGrid");
  if(!list.length){grid.innerHTML="<p>No archived alerts match your filters.</p>";return;}
  grid.innerHTML=list.map(a=>`
  <div class="card">
    <h3>${a.alert_type||"Alert"}</h3>
    <p><b>Date:</b> ${a.alert_date||"-"}</p>
    <p><b>Status:</b> ${a.status||"-"}</p>
    <p><b>Remarks:</b> ${a.remarks||"N/A"}</p>
    <p><b>Resolved By:</b> ${a.updated_by||"N/A"}</p>
    ${a.evidence_url?`<a href="${a.evidence_url}" target="_blank" style="color:#2563eb;">View Evidence</a>`:""}
  </div>`).join("");
}

document.getElementById("applyFilter").addEventListener("click",()=>{
  const filters={
    type:document.getElementById("filterType").value,
    start:document.getElementById("filterStart").value,
    end:document.getElementById("filterEnd").value
  };
  loadAlerts(filters);
});
</script>
</body>
</html>
