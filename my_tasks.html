<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EPHIS | My Tasks</title>
<link rel="manifest" href="manifest.json" />
<script type="module" src="main.js"></script>
<style>
/* Themed after food_control.html */
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Inter',sans-serif;
background:linear-gradient(135deg,#f8fafc 0%,#fef3c7 100%);margin:0;color:#1e293b;}
header{background:white;box-shadow:0 1px 3px rgba(0,0,0,0.06);}
.header-container{max-width:1400px;margin:0 auto;padding:1rem 1.5rem;
display:flex;justify-content:space-between;align-items:center;}
h1{font-size:1.2rem;background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
main{max-width:1400px;margin:0 auto;padding:1.5rem;}
.search-bar{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;}
.search-bar input, .search-bar select{padding:0.6rem;border-radius:10px;
border:1px solid #cbd5e1;flex:1;}
.btn{border:none;border-radius:10px;padding:0.625rem 1.25rem;font-weight:600;cursor:pointer;}
.btn-primary{background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:white;}
.btn-secondary{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;}
.card{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08);
padding:1rem;margin-bottom:1rem;transition:transform 0.15s;}
.card:hover{transform:translateY(-2px);}
.card-header{display:flex;justify-content:space-between;align-items:center;color:#2563eb;
font-weight:600;margin-bottom:0.4rem;}
.status{padding:0.25rem 0.5rem;border-radius:6px;font-size:0.8rem;color:white;}
.status.Pending{background:#f59e0b;}
.status.Ongoing{background:#3b82f6;}
.status.Completed{background:#16a34a;}
.status.Overdue{background:#dc2626;}
.actions{margin-top:0.6rem;display:flex;gap:0.4rem;flex-wrap:wrap;}
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);
background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
color:white;padding:1rem 1.5rem;border-radius:12px;opacity:0;transition:opacity 0.3s;}
.toast.show{opacity:1;}
footer{text-align:center;background:white;color:#64748b;font-size:0.85rem;padding:1rem;}
@media(max-width:700px){.card-header{flex-direction:column;align-items:flex-start;}}
</style>
</head>

<body>
<header>
  <div class="header-container">
    <h1>My Tasks</h1>
    <button class="btn btn-secondary" onclick="window.location.href='officer_dashboard.html'">Back</button>
  </div>
</header>

<main>
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search by record type or notes..." />
    <select id="statusFilter">
      <option value="">All Status</option>
      <option value="Pending">Pending</option>
      <option value="Ongoing">Ongoing</option>
      <option value="Completed">Completed</option>
      <option value="Overdue">Overdue</option>
    </select>
    <button class="btn btn-primary" id="filterBtn">Filter</button>
  </div>

  <div id="taskContainer"></div>

  <div style="text-align:center;margin-top:1.5rem;">
    <button class="btn btn-secondary" id="loadMoreBtn">Load More</button>
  </div>
</main>

<footer>County Government of Elgeyo Marakwet • EPHIS © <span id="year"></span></footer>
<div id="toast" class="toast"></div>

<script type="module">
import { supabase } from "./main.js";
const toast=document.getElementById("toast");
function showToast(m){toast.textContent=m;toast.classList.add("show");
setTimeout(()=>toast.classList.remove("show"),3000);}
document.getElementById("year").textContent=new Date().getFullYear();

let userId=null;
let page=0,limit=5,filterStatus="",searchTerm="";

async function checkSession(){
  const {data}=await supabase.auth.getSession();
  if(!data.session) window.location.href="login.html";
  else {userId=data.session.user.id;loadTasks();}
}
checkSession();

async function loadTasks(loadMore=false){
  if(!loadMore) page=0;
  const from=page*limit, to=(page+1)*limit-1;
  let query=supabase.from("officer_assignments").select("*")
      .eq("officer_id",userId)
      .order("assigned_date",{ascending:false})
      .range(from,to);
  if(filterStatus) query=query.eq("status",filterStatus);
  if(searchTerm) query=query.ilike("record_type",`%${searchTerm}%`);
  const {data,error}=await query;
  if(error){console.error(error);showToast("Error loading tasks");return;}
  renderTasks(data,loadMore);
  if(data.length===limit) page++;
}

function renderTasks(data,append=false){
  const c=document.getElementById("taskContainer");
  if(!append) c.innerHTML="";
  if(!data.length && !append){c.innerHTML="<p>No tasks found.</p>";return;}
  c.innerHTML+=data.map(t=>`
  <div class="card">
    <div class="card-header">
      <span>${t.record_type||'Task'}</span>
      <span class="status ${t.status}">${t.status}</span>
    </div>
    <p><b>Assigned:</b> ${t.assigned_date||'-'} | <b>Priority:</b> ${t.priority||'-'}</p>
    <p>${t.remarks||''}</p>
    <div class="actions">
      <button class="btn btn-primary" onclick="openRecord('${t.record_type}','${t.record_id}')">View</button>
      ${t.status!=='Completed'?
        `<button class="btn btn-secondary" onclick="markComplete('${t.id}')">Mark Complete</button>`:''}
    </div>
  </div>`).join("");
}

window.openRecord=(type,id)=>{
  let page=""; 
  switch(type){
    case "Building Inspection":page=`building_inspection_form.html?id=${id}`;break;
    case "IPC Follow-up":page=`ipc_followup_form.html?id=${id}`;break;
    case "Complaint":page=`complaints_public.html?id=${id}`;break;
    default:page=`dashboard.html`;
  }
  window.location.href=page;
};

window.markComplete=async(id)=>{
  const{error}=await supabase.from("officer_assignments")
      .update({status:"Completed"}).eq("id",id);
  if(error){console.error(error);showToast("Update failed");}
  else{showToast("Task marked as completed");loadTasks();}
};

document.getElementById("filterBtn").onclick=()=>{
  filterStatus=document.getElementById("statusFilter").value;
  searchTerm=document.getElementById("searchInput").value.trim();
  loadTasks();
};
document.getElementById("loadMoreBtn").onclick=()=>loadTasks(true);
</script>
</body>
</html>
