<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EPHIS | Supervisor Dashboard</title>
<link rel="manifest" href="manifest.json" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js"></script>
<script type="module" src="main.js"></script>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Inter',sans-serif;
background:linear-gradient(135deg,#f8fafc 0%,#fef3c7 100%);margin:0;color:#1e293b;}
header{background:white;box-shadow:0 1px 3px rgba(0,0,0,0.06);}
.header-container{max-width:1400px;margin:0 auto;padding:1rem 1.5rem;
display:flex;justify-content:space-between;align-items:center;}
h1{font-size:1.2rem;background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
main{max-width:1400px;margin:0 auto;padding:1.5rem;}
.controls{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;}
select,input{padding:0.6rem;border-radius:10px;border:1px solid #cbd5e1;}
.btn{border:none;border-radius:10px;padding:0.625rem 1.25rem;font-weight:600;cursor:pointer;}
.btn-primary{background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:white;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;}
.card{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08);
padding:1rem;transition:transform 0.15s;}
.card:hover{transform:translateY(-2px);}
.card h2{margin:0;color:#2563eb;font-size:1.05rem;}
.card p{margin:0.2rem 0;}
.metric{font-size:1.4rem;font-weight:700;margin:0.4rem 0;}
.chart-section{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08);
padding:1.5rem;margin-top:2rem;}
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);
background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
color:white;padding:1rem 1.5rem;border-radius:12px;opacity:0;transition:opacity 0.3s;}
.toast.show{opacity:1;}
footer{text-align:center;background:white;color:#64748b;font-size:0.85rem;padding:1rem;}
</style>
</head>

<body>
<header>
  <div class="header-container">
    <h1>Supervisor Dashboard</h1>
    <button class="btn btn-primary" onclick="window.location.href='officer_dashboard.html'">Officer View</button>
  </div>
</header>

<main>
  <div class="controls">
    <select id="locationFilter"><option value="">All Locations</option></select>
    <select id="sortFilter">
      <option value="officer_name">Officer Name</option>
      <option value="compliance_rate">Compliance Rate</option>
      <option value="total_inspections">Total Inspections</option>
    </select>
    <button class="btn btn-primary" id="applyFilter">Apply</button>
  </div>

  <div class="grid" id="officerGrid"></div>

  <section class="chart-section">
    <h2 style="color:#2563eb;">Inspection Volume by Officer</h2>
    <div id="barChart" style="width:100%;height:320px;"></div>
  </section>

  <section class="chart-section">
    <h2 style="color:#2563eb;">Compliance Rate Trend (%)</h2>
    <div id="lineChart" style="width:100%;height:320px;"></div>
  </section>
</main>

<footer>County Government of Elgeyo Marakwet • EPHIS © <span id="year"></span></footer>
<div id="toast" class="toast"></div>

<script type="module">
import { supabase } from "./main.js";
import { BarChart, Bar, LineChart, Line, CartesianGrid, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer } from "https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js";

const toast=document.getElementById("toast");
function showToast(m){toast.textContent=m;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),3000);}
document.getElementById("year").textContent=new Date().getFullYear();

let officers=[];

async function checkSession(){
  const {data}=await supabase.auth.getSession();
  if(!data.session) window.location.href="login.html";
  else loadPerformance();
}
checkSession();

async function loadPerformance(){
  const {data,error}=await supabase.from("vw_officer_performance").select("*");
  if(error){console.error(error);showToast("Failed to load performance data");return;}
  officers=data||[];
  populateLocationFilter(officers);
  renderGrid(officers);
  renderCharts(officers);
}

function populateLocationFilter(list){
  const locations=[...new Set(list.map(o=>o.area_location).filter(Boolean))];
  const sel=document.getElementById("locationFilter");
  sel.innerHTML='<option value="">All Locations</option>'+locations.map(l=>`<option>${l}</option>`).join("");
}

function renderGrid(list){
  const grid=document.getElementById("officerGrid");
  if(!list.length){grid.innerHTML="<p>No officer data found.</p>";return;}
  grid.innerHTML=list.map(o=>`
  <div class="card">
    <h2>${o.officer_name||'Unnamed Officer'}</h2>
    <p><b>Area:</b> ${o.area_location||'N/A'}</p>
    <p><b>Applications:</b> ${o.total_applications||0}</p>
    <p><b>Inspections:</b> ${o.total_inspections||0}</p>
    <p><b>Follow-ups:</b> ${o.total_followups||0}</p>
    <p><b>Enforcements:</b> ${o.total_enforcements||0}</p>
    <div class="metric" style="color:#059669;">${o.compliance_rate||0}%</div>
    <small>Compliance Rate</small>
  </div>`).join("");
}

function renderCharts(list){
  const barData=list.map(o=>({
    name:o.officer_name||'Officer',
    inspections:o.total_inspections||0,
    followups:o.total_followups||0
  }));
  const lineData=list.map(o=>({
    name:o.officer_name||'Officer',
    compliance:o.compliance_rate||0
  }));

  // Render bar chart
  ReactDOM.render(
    React.createElement(Recharts.ResponsiveContainer,{width:"100%",height:300},
      React.createElement(Recharts.BarChart,{data:barData},
        React.createElement(Recharts.CartesianGrid,{strokeDasharray:"3 3"}),
        React.createElement(Recharts.XAxis,{dataKey:"name",tick:{fontSize:11}}),
        React.createElement(Recharts.YAxis,null),
        React.createElement(Recharts.Tooltip,null),
        React.createElement(Recharts.Legend,null),
        React.createElement(Recharts.Bar,{dataKey:"inspections",fill:"#2563eb"}),
        React.createElement(Recharts.Bar,{dataKey:"followups",fill:"#10b981"})
      )
    ), document.getElementById("barChart")
  );

  // Render line chart
  ReactDOM.render(
    React.createElement(Recharts.ResponsiveContainer,{width:"100%",height:300},
      React.createElement(Recharts.LineChart,{data:lineData},
        React.createElement(Recharts.CartesianGrid,{strokeDasharray:"3 3"}),
        React.createElement(Recharts.XAxis,{dataKey:"name",tick:{fontSize:11}}),
        React.createElement(Recharts.YAxis,{domain:[0,100]}),
        React.createElement(Recharts.Tooltip,null),
        React.createElement(Recharts.Line,{type:"monotone",dataKey:"compliance",stroke:"#f59e0b",strokeWidth:3,dot:true})
      )
    ), document.getElementById("lineChart")
  );
}

document.getElementById("applyFilter").onclick=()=>{
  const loc=document.getElementById("locationFilter").value;
  const sort=document.getElementById("sortFilter").value;
  let filtered=[...officers];
  if(loc) filtered=filtered.filter(o=>o.area_location===loc);
  filtered.sort((a,b)=>{
    if(sort==="compliance_rate") return (b.compliance_rate||0)-(a.compliance_rate||0);
    if(sort==="total_inspections") return (b.total_inspections||0)-(a.total_inspections||0);
    return (a.officer_name||"").localeCompare(b.officer_name||"");
  });
  renderGrid(filtered);
  renderCharts(filtered);
};
</script>
</body>
</html>
