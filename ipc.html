<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Infection Prevention & Control | EPHIS</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2563eb" />
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png" />
<script type="module" src="main.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8fafc;min-height:100vh;color:#0f172a;display:flex;flex-direction:column;}
body::before{content:'';position:fixed;top:0;left:0;right:0;height:400px;background:linear-gradient(135deg,#0ea5e9 0%,#2563eb 50%,#7c3aed 100%);z-index:-1;opacity:0.05;}
header{background:white;box-shadow:0 1px 3px rgba(0,0,0,0.05);padding:1.2rem 2rem;border-bottom:1px solid #e2e8f0;position:sticky;top:0;z-index:100;}
.header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:1rem;}
.header-left{display:flex;align-items:center;gap:1rem;}
.logo{width:40px;height:40px;background:linear-gradient(135deg,#0ea5e9 0%,#2563eb 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(37,99,235,0.2);font-weight:bold;color:white;font-size:1.2rem;}
header h1{font-size:1.4rem;color:#0f172a;font-weight:700;letter-spacing:-0.02em;}
.header-actions{display:flex;gap:0.75rem;align-items:center;}
.btn{padding:0.6rem 1.2rem;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.95rem;border:none;transition:all 0.2s ease;}
.btn-primary{background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:white;box-shadow:0 4px 12px rgba(37,99,235,0.2);}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(37,99,235,0.3);}
.btn-secondary{background:#10b981;color:white;}
.btn-secondary:hover{background:#059669;transform:translateY(-1px);}
.btn-light{background:white;color:#2563eb;border:2px solid #2563eb;}
.btn-light:hover{background:#2563eb;color:white;transform:translateY(-1px);}
main{flex:1;max-width:1400px;margin:0 auto;padding:2rem;width:100%;}
.section{margin-bottom:3rem;}
.section h2{color:#1e293b;margin-bottom:1.5rem;font-size:1.3rem;display:flex;align-items:center;gap:0.5rem;}
.card{background:white;border-radius:12px;padding:1.5rem;margin-bottom:1rem;box-shadow:0 1px 3px rgba(0,0,0,0.05);border:1px solid #e2e8f0;transition:all 0.2s ease;}
.card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.card-header{display:flex;justify-content:space-between;align-items:center;font-weight:700;color:#0f172a;margin-bottom:1rem;font-size:1.1rem;}
.card p{font-size:0.95rem;color:#475569;margin-bottom:0.5rem;line-height:1.6;}
.card strong{color:#1e293b;font-weight:600;}
.actions{display:flex;gap:0.6rem;margin-top:1.2rem;padding-top:1rem;border-top:1px solid #f1f5f9;}
.actions a{text-decoration:none;background:#eff6ff;color:#2563eb;padding:0.5rem 1rem;border-radius:8px;font-size:0.9rem;font-weight:600;transition:all 0.2s ease;border:1px solid #dbeafe;}
.actions a:hover{background:#2563eb;color:white;transform:translateY(-1px);}
footer{text-align:center;padding:2rem 1rem;font-size:0.9rem;color:#64748b;background:white;border-top:1px solid #e2e8f0;margin-top:3rem;}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#2563eb;color:white;padding:1rem 1.5rem;border-radius:10px;opacity:0;transition:opacity 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;}
.toast.show{opacity:1;}
.empty-state{text-align:center;padding:3rem 1rem;color:#64748b;}
.empty-state-icon{font-size:3rem;margin-bottom:1rem;}
@media(max-width:768px){header{padding:1rem;}.header-content h1{font-size:1.1rem;}main{padding:1rem;}.header-actions{width:100%;justify-content:space-between;}}
</style>
</head>

<body>
<header>
<div class="header-content">
<div class="header-left">
<div class="logo">E</div>
<h1>Infection Prevention & Control</h1>
</div>
<div class="header-actions">
<button class="btn btn-light" onclick="window.location.href='dashboard.html'">‚Üê Dashboard</button>
<button class="btn btn-secondary" id="logoutBtn">Logout</button>
</div>
</div>
</header>

<main>
<div class="section">
<h2>üè≠ Facility IPC Assessments</h2>
<button class="btn btn-primary" onclick="window.location.href='ipc_form.html'">+ New Assessment</button>
<div id="assessmentsContainer"></div>
</div>

<div class="section">
<h2>ü¶† Infection Surveillance Reports</h2>
<button class="btn btn-primary" onclick="window.location.href='ipc_form.html#report'">+ New Report</button>
<div id="reportsContainer"></div>
</div>
</main>

<footer><p>&copy; <span id="year"></span> EPHIS - Elgeyo Marakwet County Environmental Health System</p></footer>
<div id="toast" class="toast"></div>

<script type="module">
import { supabase } from "./main.js";
const toast=document.getElementById("toast");
const logoutBtn=document.getElementById("logoutBtn");

function showToast(msg){toast.textContent=msg;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),3000);}
async function checkSession(){const{data}=await supabase.auth.getSession();if(!data.session)window.location.href="login.html";}
checkSession();

async function loadAssessments(){
const {data,error}=await supabase.from("ipc_facility_assessments").select("*").order("assessment_date",{ascending:false}).limit(5);
if(error){console.error(error);return;}
const c=document.getElementById("assessmentsContainer");
if(!data.length){c.innerHTML=`<div class="empty-state"><div class="empty-state-icon">üè≠</div><h3>No assessments found</h3><p>Start by creating a new facility assessment</p></div>`;return;}
c.innerHTML=data.map(d=>`
<div class="card">
<div class="card-header"><span>${d.facility_name}</span><span>${d.assessment_date||''}</span></div>
<p><strong>Auditor:</strong> ${d.auditor_name||'-'} | <strong>Compliance:</strong> ${d.compliance_level||'-'} (${d.compliance_score||'--'}%)</p>
<p><strong>Status:</strong> ${d.status||'-'}</p>
<div class="actions">
<a href="ipc_actions.html?id=${d.id}">üéØ Actions</a>
<a href="ipc_followups.html?id=${d.id}">üìã Follow-ups</a>
</div>
</div>`).join("");
}

async function loadReports(){
const {data,error}=await supabase.from("ipc_surveillance_reports").select("*").order("report_date",{ascending:false}).limit(5);
if(error){console.error(error);return;}
const c=document.getElementById("reportsContainer");
if(!data.length){c.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ü¶†</div><h3>No surveillance reports found</h3><p>Start by adding a new infection surveillance report</p></div>`;return;}
c.innerHTML=data.map(r=>`
<div class="card">
<div class="card-header"><span>${r.facility_name||'Unknown Facility'}</span><span>${r.report_date||''}</span></div>
<p><strong>Infection:</strong> ${r.infection_type||'-'} | <strong>Cases:</strong> ${r.number_of_cases||0}</p>
<p><strong>Severity:</strong> ${r.severity||'-'} | <strong>Status:</strong> ${r.status||'-'}</p>
<p><strong>Reported By:</strong> ${r.reported_by||'-'}</p>
</div>`).join("");
}

logoutBtn.onclick=async()=>{await supabase.auth.signOut();window.location.href="login.html";}
document.getElementById("year").textContent=new Date().getFullYear();
loadAssessments();loadReports();
</script>
</body>
</html>
