<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Complaints & Incidents | EPHIS</title>
  <script type="module" src="main.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f6fa;
      margin: 0;
      color: #222;
      padding-bottom: 100px;
    }
    header {
      background: #1976d2;
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 1.1rem; margin: 0; }
    .toolbar {
      display: flex; flex-wrap: wrap;
      align-items: center; gap: 0.4rem;
      background: white; border-bottom: 1px solid #eee; padding: 0.6rem;
    }
    .toolbar input {
      flex: 1; min-width: 140px;
      padding: 0.5rem; border: 1px solid #ccc;
      border-radius: 6px; font-size: 0.9rem;
    }
    .filter-btn {
      border: none; background: #eee;
      padding: 0.4rem 0.8rem; border-radius: 20px;
      font-weight: 600; color: #333; white-space: nowrap;
    }
    .filter-btn.active { background: #1976d2; color: white; }

    .card {
      background: #fff; border-radius: 10px; margin: 0.8rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
    .card-header {
      background: #e3f2fd; padding: 0.8rem 1rem;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #ddd;
    }
    .card-header h3 { margin: 0; font-size: 1rem; }
    .card-body { padding: 0.8rem 1rem; }
    .tag, .urgency {
      display: inline-block; padding: 0.2rem 0.6rem;
      border-radius: 5px; font-size: 0.8rem; font-weight: 600; text-transform: capitalize;
    }
    .tag.pending { background: #fff3cd; color: #856404; }
    .tag.resolved { background: #d4edda; color: #155724; }
    .tag.inprogress { background: #cce5ff; color: #004085; }
    .tag.escalated { background: #f8d7da; color: #721c24; }
    .urgency.low { color: #388e3c; }
    .urgency.medium { color: #f57c00; }
    .urgency.high { color: #d32f2f; }
    .urgency.critical { color: #b71c1c; }
    .details {
      display: none; color: #555; font-size: 0.9rem;
      border-top: 1px solid #eee; padding: 0.6rem 1rem; background: #fafafa;
    }
    .details.active { display: block; animation: fadeIn 0.2s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fab {
      position: fixed; bottom: 20px; right: 20px;
      background: #1976d2; color: white; border-radius: 50%;
      width: 56px; height: 56px; font-size: 30px; border: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: pointer;
    }
    #loadMore {
      display: block; margin: 1rem auto;
      padding: 0.6rem 1rem; background: #1976d2;
      color: white; border: none; border-radius: 6px; font-weight: 600;
    }
    .action-btn {
      display: inline-block;
      background: #1976d2;
      color: white;
      padding: 0.3rem 0.6rem;
      border: none;
      border-radius: 4px;
      margin-right: 0.3rem;
      margin-top: 0.3rem;
      font-size: 0.8rem;
      font-weight: 500;
    }
  </style>
</head>

<body data-module="complaints">
  <header>
    <h1>Complaints</h1>
    <button onclick="window.location.href='dashboard.html'"
      style="background:white;color:#1976d2;padding:0.4rem 0.8rem;border:none;border-radius:6px;">
      Back
    </button>
  </header>

  <div class="toolbar" id="filters">
    <button class="filter-btn active" data-status="">All</button>
    <button class="filter-btn" data-status="Pending">Pending</button>
    <button class="filter-btn" data-status="In Progress">In Progress</button>
    <button class="filter-btn" data-status="Resolved">Resolved</button>
    <button class="filter-btn" data-status="Escalated">Escalated</button>
    <input type="search" id="searchInput" placeholder="Search complaints..." />
  </div>

  <div id="list"></div>
  <button id="loadMore" style="display:none;">Load More</button>
  <button class="fab" id="addBtn">+</button>

  <script type="module">
    import { supabase, showToast, updateRecord, requireLogin } from './main.js';
    const listEl = document.getElementById('list');
    const loadMoreBtn = document.getElementById('loadMore');
    const filters = document.querySelectorAll('.filter-btn');
    const searchInput = document.getElementById('searchInput');
    const addBtn = document.getElementById('addBtn');
    let complaints = [];
    let page = 0;
    const pageSize = 8;

    await requireLogin();
    await loadPage();

    async function loadPage(reset=false){
      if(reset){ page=0; complaints=[]; listEl.innerHTML=''; }
      const from=page*pageSize, to=from+pageSize-1;
      const {data,error}=await supabase.from('complaints')
        .select('id,complaint_type,incident_date,location,urgency,resolution_status,severity,assigned_department')
        .order('created_at',{ascending:false})
        .range(from,to);
      if(error) return console.error(error);
      if(!data.length && page===0) listEl.innerHTML="<p style='text-align:center;'>No complaints found.</p>";
      complaints=complaints.concat(data);
      renderList(data);
      loadMoreBtn.style.display=data.length<pageSize?'none':'block';
      page++;
    }

    function renderList(rows){
      rows.forEach(r=>{
        const card=document.createElement('div');
        const status=(r.resolution_status||'Pending').toLowerCase().replace(' ','');
        const urgency=(r.urgency||'Medium').toLowerCase();
        card.className='card';
        card.innerHTML=`
          <div class="card-header">
            <div><h3>${r.complaint_type||'Unspecified'}</h3>
              <small>${r.location||'No location'} • ${r.incident_date||''}</small>
            </div>
            <span class="tag ${status}">${r.resolution_status||'Pending'}</span>
          </div>
          <div class="card-body">
            <p><b>Urgency:</b> <span class="urgency ${urgency}">${r.urgency}</span></p>
            ${r.assigned_department?`<p><b>Dept:</b> ${r.assigned_department}</p>`:''}
            ${r.severity?`<p><b>Severity:</b> ${r.severity}</p>`:''}
            <button class="expandBtn action-btn" data-id="${r.id}">View Details</button>
          </div>
          <div class="details" id="details-${r.id}"></div>`;
        listEl.appendChild(card);
      });
      document.querySelectorAll('.expandBtn').forEach(btn=>btn.onclick=()=>toggleDetails(btn.dataset.id));
    }

    async function toggleDetails(id){
      const section=document.getElementById(`details-${id}`);
      const open=document.querySelector('.details.active');
      if(open&&open!==section){open.classList.remove('active');open.innerHTML='';}
      section.classList.toggle('active');
      if(section.classList.contains('active')&&!section.dataset.loaded){
        section.innerHTML='<p style="color:gray;">Loading details...</p>';
        const [u,r,d]=await Promise.all([
          supabase.from('complaint_updates').select('status_log,officer_name,update_time').eq('complaint_id',id).order('update_time',{ascending:false}).limit(3),
          supabase.from('complaint_resolution').select('resolution_status,resolution_date,resolution_description,verification_officer,verified_by_supervisor').eq('complaint_id',id).limit(1),
          supabase.from('complaint_docs').select('evidence_url,investigation_report_url,resolution_report_url,supporting_docs_url').eq('complaint_id',id).limit(5)
        ]);
        if(u.error||r.error||d.error){section.innerHTML='<p style="color:red;">Error loading details.</p>';return;}
        const updates=u.data||[],res=r.data?.[0],docs=d.data||[];
        section.innerHTML=`
          <div><h4>Recent Updates</h4>
            ${updates.length?updates.map(x=>`<p><b>${x.status_log}</b><br><small>${x.officer_name||'N/A'} • ${new Date(x.update_time).toLocaleString()}</small></p>`).join(''):'<p>No updates.</p>'}
          </div>
          ${res?`<div style="margin-top:0.6rem;">
            <h4>Resolution</h4>
            <p><b>Status:</b> ${res.resolution_status||'-'}<br><b>Date:</b> ${res.resolution_date||'-'}<br>
            <b>Description:</b> ${res.resolution_description||'N/A'}<br>
            <b>Verified:</b> ${res.verification_officer||'N/A'} (${res.verified_by_supervisor?'Supervisor Verified':'Not Verified'})</p></div>`:''}
          <div class="docs-section" style="margin-top:0.6rem;">
            <h4>Evidence & Documents</h4>
            ${docs.length?docs.map(d=>`<p><a href="${d.evidence_url||d.supporting_docs_url}" target="_blank">${d.evidence_url?'Evidence Photo':'Document'}</a></p>`).join(''):'<p>No documents uploaded.</p>'}
            <button class="action-btn" onclick="initUpload('${id}')">Upload</button>
          </div>
          <div style="margin-top:0.6rem;">
            <h4>Actions</h4>
            <button class="action-btn" onclick="window.location.href='complaint_updates.html?id=${id}'">Add Update</button>
            <button class="action-btn" onclick="window.location.href='complaint_assignment.html?id=${id}'">Assign Officer</button>
            <button class="action-btn" onclick="window.location.href='complaint_resolution.html?id=${id}'">Resolve</button>
            <button class="action-btn" onclick="window.location.href='complaint_feedback.html?id=${id}'">Feedback</button>
          </div>`;
        section.dataset.loaded=true;
      }
    }

    loadMoreBtn.onclick=()=>loadPage();

    filters.forEach(f=>f.addEventListener('click',async()=>{
      filters.forEach(b=>b.classList.remove('active'));
      f.classList.add('active');
      const s=f.dataset.status;
      listEl.innerHTML='';
      const {data}=await supabase.from('complaints')
        .select('id,complaint_type,incident_date,location,urgency,resolution_status,severity,assigned_department')
        .eq('resolution_status',s||undefined).order('created_at',{ascending:false}).range(0,pageSize-1);
      complaints=data||[];
      renderList(data);loadMoreBtn.style.display=data.length<pageSize?'none':'block';
    }));

    searchInput.addEventListener('input',e=>{
      const term=e.target.value.toLowerCase();
      document.querySelectorAll('.card').forEach(c=>{c.style.display=c.innerText.toLowerCase().includes(term)?'':'none';});
    });

    addBtn.onclick=()=>window.location.href='complaint_form.html';
  </script>

  <script type="module">
    import { supabase, showToast } from './main.js';
    async function ensureBucket(){
      const {data}=await supabase.storage.listBuckets();
      if(!data.some(b=>b.name==='complaint_evidence'))
        await supabase.storage.createBucket('complaint_evidence',{public:true});
    }
    ensureBucket();

    window.initUpload=async function(id){
      const fileInput=document.createElement('input');
      fileInput.type='file';fileInput.accept='image/*,application/pdf';fileInput.multiple=true;
      fileInput.style.display='none';document.body.appendChild(fileInput);
      fileInput.onchange=async e=>{
        for(const file of e.target.files){
          const ext=file.name.split('.').pop();
          const path=`${id}/${Date.now()}.${ext}`;
          const {error:upErr}=await supabase.storage.from('complaint_evidence').upload(path,file);
          if(upErr){showToast('Upload failed: '+upErr.message,'error');continue;}
          const {data:urlData}=supabase.storage.from('complaint_evidence').getPublicUrl(path);
          const url=urlData.publicUrl;
          await supabase.from('complaint_docs').insert([{complaint_id:id,
            evidence_url:file.type.startsWith('image/')?url:null,
            supporting_docs_url:file.type==='application/pdf'?url:null
          }]);
          showToast('File uploaded','success');
        }
        document.body.removeChild(fileInput);
      };
      fileInput.click();
    };
  </script>

  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js')
        .then(()=>console.log('Service Worker registered'))
        .catch(err=>console.error('SW registration failed',err));
    }
  </script>
</body>
</html>
